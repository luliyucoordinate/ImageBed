---
layout: post
title: IA-32指令系统概述
category : 计算机系统原理
tags : [notes, 原理]
stickie: true
---


程序转换概述
===

指令的概念
---
计算机中的指令有微指令、机器指令和伪指令  
机器指令处于硬件和软件的交界面，相当于一个菜谱指定的一个完整做菜过程  
微指令是微程序命令，属于硬件范畴，相当于洗，切煮等过程  
伪指令是由若干机器指令组成的指令序列，属于软件范畴，相当于由多个菜谱合成一个大菜的过程  
汇编指令是机器指令的汇编表示形式，即符号表示。机器指令与汇编指令一一对应，它们都与机器结构有关，都属于机器级指令。

IA-32指令系统概述
===

IA-32的寄存器组织
---
EAX累加器000  
EBX基址寄存器011  
ECX计数寄存器001  
EDX数据寄存器010  
ESP堆栈指针100  
EBP基址指针101  
ESI源变址寄存器110  
EDI目标变址寄存器111  
EIP指令指针  
EFLAGS标志寄存器  
CS代码段  
SS堆栈段  
DS数据段  
ES附加段  
FS附加段  
GS附加段

IA-32的标志寄存器
---
6个条件标志  
零标志ZF、溢出标志OF、进借位标志CF、符号标志SF、辅助进位标志AF（BCD码运算时才有意义）、奇偶标志PF  
3个控制标志  
DF：方向标志（自动变址方向是增还是减）  
IF：中断允许标志（仅对外部可屏蔽中断有用）  
TF：陷阱标志（是否是单步跟踪状态）   

IA-32的寻址方式
---
寻址方式：如何根据指令给定信息得到操作数或操作数的地址  
操作数所在的位置:   
1.  指令中：立即寻址    
2.  寄存器中：寄存器寻址  
3.  存储单元中（属于存储器操作数，按字节编址）：其他寻址方式

存储器操作数的寻址方式与微处理器的工作模式有关：   
1.  实地址模式（基本用不到）  
  为与8086/8088兼容设置，加电或复位时，寻址空间1MB，20位地址：(CS) << 4 + (IP)  
2.  保护模式（需要掌握）  
  加电后进入，采用虚拟存储管理，多任务情况下隔离、保护，80286以上微处理器的工作方式，寻址空间2^32B，32位线性寻址分段（段基址+段内偏移量）

存储器操作数的寻址方式  
在linux系统中：double型变量按4B边界对齐  
在windows系统中：double型变量按8B边界对齐  

```c
float a[100];
short b[4][4];
double d[10];
```
a[i]的地址计算：$$104+i*4$$，位移+比例变址   
b\[i\][j]的地址计算：$$504+i*8+j*2(4*2 = 8)$$，位移+基址+比例变址  
d[i]的地址计算：$$544+i*8$$，位移+比例变址  
将b\[i\][j]取到AX中的指令可以是：movew 504(%ebp, %esi), %ax，其中i*8在EBP中，j在ESI中，2为比例因子

IA-32机器指令格式
---
<table border="1" align="left">
    <tr>
        <td>操作码</td>
        <td>寻址方式</td>
        <td>SIB</td>
        <td>位移</td>
        <td>直接数据</td>
    </tr>
    <tr>
        <td>1或2</td>
        <td>0或1</td>
        <td>0或1</td>
        <td>1、2、4</td>
        <td>立即数</td>
    </tr>
</table>
<br />
<br />

寻址方式

<table border="1" align="left">
    <tr>
        <td>Mod</td>
        <td>Reg/OP</td>
        <td>R/M</td>
    </tr>
    <tr>
        <td>(6~7)</td>
        <td>(3~5)</td>
        <td>(0~2)</td>
    </tr>
</table>
<br />
<br />

SIB

<table border="1" align="left">
    <tr>
        <td>SS</td>
        <td>Index</td>
        <td>Base</td>
    </tr>
    <tr>
        <td>(6~7)</td>
        <td>(3~5)</td>
        <td>(0~2)</td>
    </tr>
</table>
<br />
<br />

位移量和立即数都可以是：1B/2B/4B  
SIB中的基址B和变址I都可以是8个GRS中任一个：SS给出比例因子(00 01 10 11)  
操作码：opcode；W：与机器模式（16/32位）一起确定寄存器位数（AL/AX/EAX）；D：操作方向（确定源和目标）  
寻址方式：mod、r/m、reg/op三个字段与w字段和机器模式(16/32)一起确定操作数所在的寄存器编号或有效地址计算方式  
例如：  

```
1000 1101 0000 0100 0000 0010
8d 04 02 leal (%edx,%eax,1),%eax
1:SS eax:Index edx:Base eax:Reg/OP
```
