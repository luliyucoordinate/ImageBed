---
layout: post
title: QT5.9.1与opencv3.3读取图片
category : QT
tags : [opencv, cpp, qt]
stickie: true
---

首先我们要新建一个项目，选择Qt Widgets Application

<a href="http://wx1.sinaimg.cn/mw690/af2d2659ly1fkppk07so9j20oi0fjwez.jpg" data-lightbox="roadtrip">
<img src="http://wx1.sinaimg.cn/mw690/af2d2659ly1fkppk07so9j20oi0fjwez.jpg" class="img-fluid">
</a>

一直点击下一步，直到出现下面这个窗口（项目名称自己填写一个）

<a href="http://wx4.sinaimg.cn/mw690/af2d2659ly1fkppk0lrthj20p20d9glq.jpg" data-lightbox="roadtrip">
<img src="http://wx4.sinaimg.cn/mw690/af2d2659ly1fkppk0lrthj20p20d9glq.jpg" class="img-fluid">
</a>

注意这里的基类我们要选择QMianWindow，因为我们要做一个带有菜单的界面。接着点击下一步完成即可。

点击pro文件，添加opencv的路径，以及我们所需的相关库文件，例如

<a href="http://wx4.sinaimg.cn/mw690/af2d2659ly1fkppk1kzddj206k05egll.jpg" data-lightbox="roadtrip">
<img src="http://wx4.sinaimg.cn/mw690/af2d2659ly1fkppk1kzddj206k05egll.jpg" class="img-fluid">
</a>

```c++
INCLUDEPATH +=  F:\opencv\opencv3\QT_opencv\include\opencv \
                F:\opencv\opencv3\QT_opencv\include\opencv2 \
                F:\opencv\opencv3\QT_opencv\include
LIBS += -L F:\opencv\opencv3\QT_opencv\x86\mingw\lib\libopencv_*.a
```

按照我这篇[文章](http://blog.csdn.net/qq_17550379/article/details/78296057)里面讲的方法，将相应的dll文件copy到工程目录中去（如果不这样做会出现crashed问题）。

然后双击`mianwindow.ui`，接下来我们设计图形界面。

双击`在这里输入`，我这里输入`文件(F)`，然后点击我们创建好的`文件(F)` 我们接着在创建一个`a`，因为我们这里无法输入汉字，所以先输入一个字母代替。

接着选中这个`a`，在下面的菜单栏中修改名称为`actionOpenFile`，双击快捷键出现编辑动作选项，我们选中`shortcut`然后按下`ctrl+f`组合键，即可创建快捷键。如图

<a href="http://wx4.sinaimg.cn/mw690/af2d2659ly1fkppwqxx4hj20at08lmx3.jpg" data-lightbox="roadtrip">
<img src="http://wx4.sinaimg.cn/mw690/af2d2659ly1fkppwqxx4hj20at08lmx3.jpg" class="img-fluid">
</a>

然后右击，选择`转到槽`，QAction选择triggered，生成对应的槽函数。再回到ui界面。

从左边的菜单栏中的Display Widgets中选择出label，将它拖到主界面中。

<a href="http://wx1.sinaimg.cn/mw690/af2d2659ly1fkppzmyxvdj20hg0dbglj.jpg" data-lightbox="roadtrip">
<img src="http://wx1.sinaimg.cn/mw690/af2d2659ly1fkppzmyxvdj20hg0dbglj.jpg" class="img-fluid">
</a>

双击label，删除里面的文字信息。调整label的大小，使它和整个界面大小一致。最后的界面是这样的

<a href="http://wx3.sinaimg.cn/mw690/af2d2659ly1fkppjzr0b3j21f60u041o.jpg" data-lightbox="roadtrip">
<img src="http://wx3.sinaimg.cn/mw690/af2d2659ly1fkppjzr0b3j21f60u041o.jpg" class="img-fluid">
</a>

ui界面就搞定了，接下来解决槽函数的编写。

我们这里使用QImage存储图片对象，而opencv中使用的是Mat数据结构，所以我们要做一些转换操作。使用cvtColor函数将Mat的BGR顺序转换为QImage的RGB顺序。

要添加如下头文件

```c++
#include <QMessageBox>
#include <opencv.hpp>
#include <QImage>
#include <QFileDialog>
#include <QFile>
```

槽函数为

```c++
void MainWindow::on_actionOpenFile_triggered()
{
    //打开文件选择框
    QString path = QFileDialog::getOpenFileName(this, tr("open"), tr("../"));
    if(!path.isEmpty())
    {
        //读取一幅图片，这里我们要将QString转换为String使用toStdString函数
        cv::Mat image = cv::imread(path.toStdString());
        if(!image.data)
        {
            QMessageBox::warning(this, tr("警告"),tr("图片打开失败"));
            return;
        }
        else
        {
            //改变彩色通道顺序
            cv::cvtColor(image, image, CV_RGB2BGR);
            //初始化QImage对象
            QImage img = QImage((const unsigned char*)(image.data), image.cols, image.rows, QImage::Format_RGB888);
            //显示在label中
            ui->label->setPixmap(QPixmap::fromImage(img));
            //改变label的大小用于自适应图像大小
            ui->label->resize(ui->label->pixmap()->size());
        }
    }
    else
    {
        QMessageBox::warning(this, tr("警告"),tr("请选择文件"));
        return;
    }
}
```

最后的效果图

<a href="http://wx3.sinaimg.cn/mw690/af2d2659ly1fkpv4q9f2gj20hj0ef3ys.jpg" data-lightbox="roadtrip">
<img src="http://wx3.sinaimg.cn/mw690/af2d2659ly1fkpv4q9f2gj20hj0ef3ys.jpg" class="img-fluid">
</a>

至此我们实现了一个简单的图片读取功能，下一讲我会对这个功能进行一些优化。